# ドラッグ＆ドロップ機能の仕様

## 概要

mefront アプリケーションは、画像のドラッグ＆ドロップによる物体検出機能を提供します。

## 機能仕様

### 1枚目の画像をドロップ

- DropZone コンポーネントにファイルをドラッグ＆ドロップまたはクリックして選択
- 対応フォーマット: JPG, PNG, GeoTIFF (.tif, .tiff)
- 画像読み込み後、自動的に物体検出を実行
- 検出結果を画像上に表示

### 2枚目の画像をドロップ

1枚目の画像が表示されている状態で、その上に2枚目の画像をドロップできます。

#### 動作:

1. **物体検出の実行**
   - 2枚目の画像に対して自動的に物体検出を実行

2. **両方が GeoTIFF の場合**
   - 1枚目と2枚目の検出結果を統合
   - 地理座標を使用して重複を自動排除
   - IoU (Intersection over Union) しきい値: 0.5
   - 重複する検出の場合、信頼度の高い方を保持
   - 統合結果を1枚目の画像上に表示
   - 統合済み GeoJSON のダウンロードが可能
   - ステータスメッセージ: "検出完了: N 件 (統合結果: M 件)"

3. **それ以外の場合**
   - 2枚目の画像の検出結果で置き換え
   - 2枚目の画像を表示
   - ステータスメッセージ: "検出完了: N 件 (2枚目の画像に置き換えました)"

## UI 要素

### DropZone (初期状態)
- 画像が未読み込みの場合に表示
- ドラッグオーバー時にハイライト表示

### DetectionCanvas (画像表示中)
- 1枚目の画像表示時、2枚目のドロップを受け付ける
- ドラッグオーバー時: "2枚目の画像をドロップ" メッセージ表示
- 右下に常時ヒント: "2枚目の画像をドロップできます"
- 2枚目がロード済みの場合、ドロップを無効化

### 結果パネル (ResultPanel)
- 検出数の表示
- GeoTIFF の場合: EPSG コード表示
- 統合済みの場合: "統合済み (重複排除)" バッジ表示
- ダウンロードボタン:
  - 統合 GeoTIFF: "統合GeoJSON をダウンロード"
  - 通常 GeoTIFF: "GeoJSON をダウンロード"
  - 通常画像: "JSON をダウンロード"

## 実装詳細

### 主要コンポーネント

- **App.tsx**: メインロジック、状態管理
- **DropZone.tsx**: 初期ドロップエリア
- **DetectionCanvas.tsx**: 画像表示＆2枚目のドロップ受付
- **ResultPanel.tsx**: 結果表示とダウンロード
- **exportResults.ts**: GeoJSON 生成、統合ロジック

### 統合アルゴリズム

`mergeGeoTIFFDetections()` 関数:
1. 両画像の検出結果を地理座標に変換
2. 同じクラスの検出のみ比較
3. IoU 計算で重複判定
4. 信頼度の高い検出を保持
5. 重複しない検出を追加

### テスト

`src/lib/__tests__/exportResults.test.ts` に以下のテストが含まれます:
- 重複なし統合
- 重複検出と排除
- 信頼度による選択
- クラス別の比較
- 空配列の処理

## 使用例

1. 最初の GeoTIFF ファイルをドロップ
2. 隣接する領域の2枚目の GeoTIFF ファイルをドロップ
3. 統合された検出結果を確認
4. "統合GeoJSON をダウンロード" ボタンで結果を保存
